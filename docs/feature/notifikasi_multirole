# Project Requirement Document (PRD): Sistem Notifikasi In-App

## 1. Analisis Masalah Utama

Sistem peminjaman saat ini membutuhkan mekanisme komunikasi internal yang cepat agar setiap aktor (Mahasiswa, Sarpras, Security) mengetahui perubahan status peminjaman secara langsung tanpa harus melakukan *refresh* halaman secara manual atau mengecek email.

## 2. Identifikasi Asumsi & Data Terkait

* **Aktor:** Mahasiswa (Peminjam), Sarpras (Verifikator), dan Security (Pemantau Lapangan).
* **Data Eksisting:** Sudah terdapat tabel `notifikasi` dan model `Notifikasi` yang memiliki kolom `kode_notifikasi`, `kode_user` (penerima), `kode_peminjaman`, `jenis_notifikasi`, `pesan`, dan `status`.
* **Teknologi:** Backend Golang dengan repository yang mendukung pengambilan jumlah pesan belum dibaca (`GetUnreadCount`) dan menandai pesan dibaca (`MarkAsRead`).

## 3. Persyaratan Fungsional (Backend)

### A. Mekanisme Trigger (Pemicu)

Notifikasi harus dibuat secara otomatis di dalam layer **Service** (bukan Handler) setiap kali terjadi aksi berikut:

| Event | Pemicu (Service Method) | Penerima (Role) | Jenis Notifikasi |
| --- | --- | --- | --- |
| **Pengajuan Baru** | `CreatePeminjaman` | Semua **Sarpras** | `PENGAJUAN_MASUK` |
| **Approval** | `VerifikasiPeminjaman` | **Mahasiswa** (Peminjam) | `PEMINJAMAN_DISETUJUI` |
| **Approval** | `VerifikasiPeminjaman` | Semua **Security** | `INFO_KEGIATAN` |
| **Rejection** | `VerifikasiPeminjaman` | **Mahasiswa** (Peminjam) | `PEMINJAMAN_DITOLAK` |
| **Check-in Hadir** | `VerifyKehadiran` | Semua **Sarpras** | `KEHADIRAN_DIVERIFIKASI` |

### B. Spesifikasi API

Backend harus menyediakan endpoint berikut yang sudah terhubung ke `NotifikasiHandler`:

1. `GET /api/notifikasi`: Mengambil daftar notifikasi milik user yang sedang login (limit 50, terbaru di atas).
2. `GET /api/notifikasi/unread-count`: Mengambil jumlah notifikasi dengan status `TERKIRIM`.
3. `PUT /api/notifikasi/mark-as-read`: Mengubah status menjadi `DIBACA` berdasarkan `kode_notifikasi`.

## 4. Persyaratan UI/UX (Frontend - Vanilla JS & Tailwind)

### A. Komponen Lonceng (Navbar)

* **Visual:** Ikon lonceng dengan *badge* merah di pojok kanan atas.
* **Logika:** Badge hanya muncul jika `unread_count > 0`.
* **Interaksi:** Klik ikon lonceng membuka dropdown panel.

### B. Panel Dropdown Notifikasi

* **Header:** Judul "Notifikasi" dan tombol "Tandai Semua Dibaca".
* **List Item:**
* **Belum Dibaca:** Latar belakang biru muda (Tailwind `bg-blue-50`).
* **Sudah Dibaca:** Latar belakang putih.
* **Konten:** Pesan singkat dan waktu relatif (contoh: "5 menit yang lalu").


* **Footer:** Link "Lihat Semua Notifikasi".

### C. UX Multi-role

* **Mahasiswa:** Notifikasi bersifat informatif (Status berubah).
* **Sarpras & Security:** Notifikasi bersifat instruktif (Ada tugas verifikasi atau pantauan baru).

## 5. Alur Implementasi (Flow)

### Langkah 1: Integrasi Service

Di dalam `services/peminjaman_service.go`, panggil `NotifikasiRepository.Create` setelah logika database peminjaman berhasil.

* **Hidden Assumption:** Jika pengiriman ke banyak user (seperti ke semua Sarpras), gunakan loop atau fungsi `CreateBulk`.

### Langkah 2: Frontend Polling

Karena lingkupnya website, gunakan teknik *short polling* pada file `assets/js/api.js`:

1. Fungsi `checkNotifications()` dijalankan setiap 60 detik menggunakan `setInterval`.
2. Update elemen DOM badge notifikasi berdasarkan hasil API `unread-count`.

### Langkah 3: Penanganan Klik

1. User klik item di dropdown.
2. JS memanggil API `MarkAsRead`.
3. JS melakukan *redirect* ke halaman terkait (contoh: jika tentang peminjaman, arahkan ke halaman detail peminjaman tersebut).

## 6. Alternatif Pemeriksaan (Skeptisisme Sehat)

* **Masalah Performa:** Jika user sangat banyak, polling setiap 60 detik bisa membebani server.
* **Solusi:** Implementasikan **Supabase Realtime** (Websocket) di masa mendatang jika skala pengguna meningkat, sehingga server yang "mendorong" data ke klien tanpa perlu polling.

## 7. Kesimpulan

Sistem notifikasi in-app ini akan menggunakan infrastruktur tabel `notifikasi` yang sudah ada. Fokus utama adalah pada **sinkronisasi trigger** di backend service dan **pembuatan komponen dropdown** yang responsif di frontend menggunakan Tailwind CSS.